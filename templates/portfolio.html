{% extends "base.html" %}
{% block content %}

<main class="dashboard">
  {% if show_onboarding %}
  <!-- Onboarding Form -->
  <div class="glass financial-summary-card">
    <h2>Welcome to ArthaX!</h2>
    <p class="helper-text" style="margin-bottom: 2rem;">Let's set up your financial profile to get started.</p>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash-message flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    
    <form method="POST" action="{{ url_for('portfolio') }}" class="onboarding-form">
      <input type="hidden" name="onboarding" value="true">
      
      <div class="form-group">
        <label for="monthly_income">Monthly Income (‚Çπ)</label>
        <input type="number" id="monthly_income" name="monthly_income" min="0" step="0.01" placeholder="0.00" required>
      </div>
      
      <div class="form-group">
        <label for="savings_goal">Savings Goal (‚Çπ)</label>
        <input type="number" id="savings_goal" name="savings_goal" min="0" step="0.01" placeholder="0.00" required>
      </div>
      
      <div class="form-group">
        <label for="current_savings">Current Savings (‚Çπ)</label>
        <input type="number" id="current_savings" name="current_savings" min="0" step="0.01" placeholder="0.00" value="0">
      </div>
      
      <button type="submit" class="btn btn-primary">Save Profile</button>
    </form>
  </div>
  
  {% else %}
  <!-- Financial Summary Card -->
  <div class="glass financial-summary-card">
    <h2>Your Financial Summary</h2>
    <div class="summary-metrics">
      <div class="metric-item">
        <div class="metric-icon">üí∞</div>
        <div class="metric-content">
          <div class="metric-label">Total Spent (This Month)</div>
          <div class="metric-value">‚Çπ{{ "{:,.0f}".format(financial_data.total_spent) }}</div>
        </div>
      </div>
      <div class="metric-item">
        <div class="metric-icon">üè¶</div>
        <div class="metric-content">
          <div class="metric-label">Savings This Month</div>
          <div class="metric-value">‚Çπ{{ "{:,.0f}".format(financial_data.savings_this_month) }}</div>
        </div>
      </div>
      <div class="metric-item">
        <div class="metric-icon">üíé</div>
        <div class="metric-content">
          <div class="metric-label">Total Savings</div>
          <div class="metric-value" id="totalSavingsValue">‚Çπ{{ "{:,.0f}".format(financial_data.total_savings) }}</div>
        </div>
      </div>
      <div class="metric-item">
        <div class="metric-icon">üéØ</div>
        <div class="metric-content">
          <div class="metric-label">
            Savings Goal
            <button type="button" id="editSavingsGoalBtn" style="border: none; background: transparent; color: #a5b4fc; font-size: 0.9rem; cursor: pointer; padding: 0 0.35rem; margin-left: 0.35rem;">‚úèÔ∏è Edit</button>
          </div>
          <div class="metric-value">‚Çπ{{ "{:,.0f}".format(financial_data.profile.savings_goal) }}</div>
        </div>
      </div>
      <div class="metric-item progress-item">
        <div class="metric-icon">üìä</div>
        <div class="metric-content">
          <div class="metric-label">Progress</div>
          <div class="progress-container">
            <div class="progress-bar" id="savingsProgressBar" style="width: {{ financial_data.savings_progress }}%">
              <span class="progress-text">{{ "{:.0f}".format(financial_data.savings_progress) }}%</span>
            </div>
          </div>
          <div class="progress-amounts">
            <span id="progressTotalSavings">‚Çπ{{ "{:,.0f}".format(financial_data.total_savings) }}</span>
            <span id="progressGoalValue">‚Çπ{{ "{:,.0f}".format(financial_data.profile.savings_goal) }}</span>
          </div>
        </div>
      </div>
    </div>
    <p class="helper-text">Track your spending and stay aligned with your goals.</p>
  </div>

  <!-- Portfolio Action Buttons -->
  <div style="display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 2rem;">
    <!-- Add Expense Button -->
    <button class="glass add-expense-btn" id="addExpenseBtn">
      <span class="btn-icon">‚ûï</span>
      <span>Add Expense</span>
    </button>

    <!-- Add Savings Button -->
    <button class="glass add-expense-btn" id="addSavingsBtn" style="max-width: 300px; margin-bottom: 2rem;">
      <span class="btn-icon">‚ûï</span>
      <span>Add Savings</span>
    </button>

    <!-- Withdraw Savings Button -->
    <button class="glass add-expense-btn" id="withdrawSavingsBtn" style="max-width: 300px; margin-bottom: 2rem;">
      <span class="btn-icon">‚ûñ</span>
      <span>Withdraw Savings</span>
    </button>
  </div>

  <!-- Expenses Table -->
  <div class="glass expenses-section">
    <h2>Recent Expenses</h2>
    <div class="table-container">
      <table class="expenses-table" id="expensesTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="expensesTableBody">
          {% if financial_data.expenses %}
            {% for expense in financial_data.expenses %}
            <tr>
              <td>{{ expense.date }}</td>
              <td>
                <span class="category-badge category-{{ expense.category|lower }}">
                  {% if expense.category == "Food" %}üçî
                  {% elif expense.category == "Transport" %}üöó
                  {% elif expense.category == "Entertainment" %}üé¨
                  {% elif expense.category == "Study" %}üìö
                  {% elif expense.category == "Utilities" %}üí°
                  {% else %}üìù{% endif %}
                  {{ expense.category }}
                </span>
              </td>
              <td class="expense-amount">‚Çπ{{ "{:,.0f}".format(expense.amount) }}</td>
              <td class="expense-note">{{ expense.note or "-" }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" style="text-align: center; color: #94a3b8; padding: 2rem;">
                No expenses yet. Click "Add Expense" to get started!
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <p class="table-helper">Every expense counts.</p>
  </div>

  <!-- Recent Savings -->
  <div class="glass expenses-section" style="margin-bottom: 2rem;">
    <h2>Recent Savings</h2>
    <div class="table-container">
      <table class="expenses-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="savingsTableBody">
          {% if financial_data.savings %}
            {% for saving in financial_data.savings %}
            <tr>
              <td>{{ saving.date }}</td>
              {% set is_negative = saving.amount < 0 %}
              <td class="expense-amount" style="color: {{ '#f87171' if is_negative else '#4ade80' }};">{{ '-' if is_negative else '+' }}‚Çπ{{ "{:,.0f}".format(saving.amount | abs) }}</td>
              <td class="expense-note">{{ saving.note or "-" }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="3" style="text-align: center; color: #94a3b8; padding: 2rem;">
                No savings yet. Click "Add Savings" to start tracking!
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</main>

{% if not show_onboarding %}

<!-- Add Expense Modal -->
<div class="modal-overlay" id="expenseModal">
  <div class="glass modal-content">
    <div class="modal-header">
      <h2>Add New Expense</h2>
      <button class="modal-close" id="closeModal">&times;</button>
    </div>
    <form id="expenseForm" class="expense-form" method="POST" action="{{ url_for('add_expense') }}">
      <div class="form-group">
        <label for="expenseDate">Date</label>
        <input type="date" id="expenseDate" name="date" required>
      </div>
      <div class="form-group">
        <label for="expenseCategory">Category</label>
        <select id="expenseCategory" name="category" required>
          <option value="">Select a category</option>
          <option value="Food">Food</option>
          <option value="Transport">Transport</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Utilities">Utilities</option>
          <option value="Study">Study</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label for="expenseAmount">Amount (‚Çπ)</label>
        <input type="number" id="expenseAmount" name="amount" min="0" step="0.01" placeholder="0.00" required>
      </div>
      <div class="form-group">
        <label for="expenseNote">Note (Optional)</label>
        <input type="text" id="expenseNote" name="note" placeholder="Add a note about this expense">
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-secondary">Add Expense</button>
        <button type="button" class="btn btn-primary" id="cancelBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Savings Modal -->
<div class="modal-overlay" id="savingsModal">
  <div class="glass modal-content">
    <div class="modal-header">
      <h2>Add Savings</h2>
      <button class="modal-close" id="closeSavingsModal">&times;</button>
    </div>
    <form id="savingsForm" class="expense-form">
      <div class="form-group">
        <label for="savingsDate">Date</label>
        <input type="date" id="savingsDate" name="date" required>
      </div>
      <div class="form-group">
        <label for="savingsAmount">Amount (‚Çπ)</label>
        <input type="number" id="savingsAmount" name="amount" min="0" step="0.01" placeholder="0.00" required>
      </div>
      <div class="form-group">
        <label for="savingsNote">Note (Optional)</label>
        <input type="text" id="savingsNote" name="note" placeholder="Add a note about this savings">
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-secondary">Add Savings</button>
        <button type="button" class="btn btn-primary" id="cancelSavingsBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Withdraw Savings Modal -->
<div class="modal-overlay" id="withdrawModal">
  <div class="glass modal-content">
    <div class="modal-header">
      <h2>Withdraw Savings</h2>
      <button class="modal-close" id="closeWithdrawModal">&times;</button>
    </div>
    <form id="withdrawForm" class="expense-form" method="POST" action="{{ url_for('withdraw_saving') }}">
      <div class="form-group">
        <label for="withdrawDate">Date</label>
        <input type="date" id="withdrawDate" name="date" required>
      </div>
      <div class="form-group">
        <label for="withdrawAmount">Amount (‚Çπ)</label>
        <input type="number" id="withdrawAmount" name="amount" min="0" step="0.01" placeholder="0.00" required>
      </div>
      <div class="form-group">
        <label for="withdrawNote">Note (Optional)</label>
        <input type="text" id="withdrawNote" name="note" placeholder="Add a note about this withdrawal">
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-secondary">Withdraw</button>
        <button type="button" class="btn btn-primary" id="cancelWithdrawBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Savings Goal Modal -->
<div class="modal-overlay" id="editGoalModal">
  <div class="glass modal-content">
    <div class="modal-header">
      <h2>Edit Savings Goal</h2>
      <button class="modal-close" id="closeEditGoalModal">&times;</button>
    </div>
    <form id="editGoalForm" class="expense-form" method="POST" action="{{ url_for('update_savings_goal') }}">
      <div class="form-group">
        <label for="newSavingsGoal">New Savings Goal (‚Çπ)</label>
        <input type="number" id="newSavingsGoal" name="new_savings_goal" min="0" step="0.01" value="{{ financial_data.profile.savings_goal }}" required>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-secondary">Save</button>
        <button type="button" class="btn btn-primary" id="cancelEditGoalBtn">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>
  {% if not show_onboarding and financial_data %}
  // Pass data to JavaScript
  window.portfolioData = {
    totalSpent: {{ financial_data.total_spent }},
    savings: {
      current: {{ financial_data.total_savings }},
      goal: {{ financial_data.profile.savings_goal }},
      progress: {{ financial_data.savings_progress }}
    },
    expenses: {{ financial_data.expenses | tojson }},
    savings_list: {{ financial_data.savings | tojson }}
  };
  {% endif %}
</script>

{% endblock %}
